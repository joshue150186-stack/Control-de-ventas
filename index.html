<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Ventas y Finanzas de Vitor</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .tab-button.active {
            border-bottom-width: 3px;
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen bg-gray-50 flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">Control de Negocio | Vitor</h1>
            <div class="text-xs text-gray-500 rounded-full bg-gray-100 px-3 py-1 truncate" id="userIdDisplay">Cargando...</div>
        </div>
        <!-- Tabs -->
        <nav class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-4 border-b border-gray-200">
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500 active" data-tab="vendedores">Vendedores</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="pos">Puntos de Venta</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="gastos">Gastos</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="resumen">Resumen</button>
            <button class="tab-button py-3 px-2 text-sm text-gray-600 hover:text-blue-500" data-tab="config">Configuración</button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6">
        <div id="content-container">
            <!-- Content will be injected here -->
        </div>
    </main>

    <!-- Custom Modal for Alerts/Confirmation -->
    <div id="custom-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform scale-95 transition-all">
            <h3 class="text-lg font-semibold text-gray-900 mb-4" id="modal-title">Atención</h3>
            <p class="text-sm text-gray-600 mb-6" id="modal-message"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition">Cancelar</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-700 transition">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-70 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-600">Cargando datos...</p>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, updateDoc, deleteDoc, addDoc, Timestamp, runTransaction, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Variables Globales ---
    const TABS = { VENDEDORES: 'vendedores', POS: 'pos', GASTOS: 'gastos', RESUMEN: 'resumen', CONFIG: 'config' };
    let currentTab = TABS.VENDEDORES;
    let vendedores = [];
    let puntosDeVenta = [];
    let movimientosPOS = [];
    let gastos = [];
    let precioUnidad = 10;
    let userId = null;
    let db, auth;
    let isAuthReady = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- DOM Elements ---
    const contentContainer = document.getElementById('content-container');
    const tabButtons = document.querySelectorAll('.tab-button');
    const loadingOverlay = document.getElementById('loading-overlay');
    const userIdDisplay = document.getElementById('userIdDisplay');

    // --- Helpers para LocalStorage ---
    const LS_KEYS = {
        VENDEDORES: `vendedores_${appId}_`,
        PUNTOS_DE_VENTA: `puntos_de_venta_${appId}_`,
        MOVIMIENTOS_POS: `movimientos_pos_${appId}_`,
        GASTOS: `gastos_${appId}_`,
        CONFIG: `config_${appId}_`
    };
    function getLSKey(base) {
        return base + userId;
    }
    function saveToLS(key, value) {
        localStorage.setItem(key, JSON.stringify(value));
    }
    function loadFromLS(key, fallback) {
        try {
            return JSON.parse(localStorage.getItem(key)) || fallback;
        } catch {
            return fallback;
        }
    }
    // --- VENDEDORES modo LocalStorage ---
    async function addVendedorLS(name) {
        const arr = loadFromLS(getLSKey(LS_KEYS.VENDEDORES), []);
        arr.push({
            id: crypto.randomUUID(),
            nombre: name,
            entregado_qty: 0,
            vendido_qty: 0,
            pagado: 0,
        });
        saveToLS(getLSKey(LS_KEYS.VENDEDORES), arr);
        vendedores = arr;
        renderVendedores();
    }
    async function updateVendedorLS(id, type, amount) {
        let arr = loadFromLS(getLSKey(LS_KEYS.VENDEDORES), []);
        const v = arr.find(v => v.id === id);
        if (!v) return;
        if (type === 'ENTREGA') {
            v.entregado_qty += amount;
        } else if (type === 'VENTA') {
            const stock = v.entregado_qty - v.vendido_qty;
            if (amount > stock) {
                showModal("Error", "La cantidad vendida excede el stock pendiente.", () => {}, false);
                return;
            }
            v.vendido_qty += amount;
        } else if (type === 'PAGO') {
            const deuda = v.vendido_qty * precioUnidad - v.pagado;
            if (amount > deuda + 0.01) {
                showModal("Error", "El pago excede la deuda pendiente.", () => {}, false);
                return;
            }
            v.pagado += amount;
        }
        saveToLS(getLSKey(LS_KEYS.VENDEDORES), arr);
        vendedores = arr;
        renderVendedores();
    }
    async function deleteVendedorLS(id) {
        let arr = loadFromLS(getLSKey(LS_KEYS.VENDEDORES), []);
        arr = arr.filter(v => v.id !== id);
        saveToLS(getLSKey(LS_KEYS.VENDEDORES), arr);
        vendedores = arr;
        renderVendedores();
    }
    // --- PUNTOS DE VENTA modo LocalStorage ---
    async function addPuntoDeVentaLS(name) {
        const arr = loadFromLS(getLSKey(LS_KEYS.PUNTOS_DE_VENTA), []);
        arr.push({
            id: crypto.randomUUID(),
            nombre: name,
            creado_en: new Date().toISOString(),
        });
        saveToLS(getLSKey(LS_KEYS.PUNTOS_DE_VENTA), arr);
        puntosDeVenta = arr;
        renderPuntosDeVenta();
    }
    async function deletePuntoDeVentaLS(id) {
        let arr = loadFromLS(getLSKey(LS_KEYS.PUNTOS_DE_VENTA), []);
        arr = arr.filter(p => p.id !== id);
        saveToLS(getLSKey(LS_KEYS.PUNTOS_DE_VENTA), arr);
        puntosDeVenta = arr;
        renderPuntosDeVenta();
    }
    // --- MOVIMIENTOS POS modo LocalStorage ---
    async function addMovimientoPOSLS(nombre, monto, envia, recibe) {
        const arr = loadFromLS(getLSKey(LS_KEYS.MOVIMIENTOS_POS), []);
        arr.push({
            id: crypto.randomUUID(),
            fecha_envio: new Date().toISOString(),
            monto: monto,
            punto_venta_nombre: nombre,
            encargado_envia: envia,
            receptor_hub: recibe,
        });
        saveToLS(getLSKey(LS_KEYS.MOVIMIENTOS_POS), arr);
        movimientosPOS = arr;
        renderPuntosDeVenta();
    }
    async function deleteMovimientoPOSLS(id) {
        let arr = loadFromLS(getLSKey(LS_KEYS.MOVIMIENTOS_POS), []);
        arr = arr.filter(m => m.id !== id);
        saveToLS(getLSKey(LS_KEYS.MOVIMIENTOS_POS), arr);
        movimientosPOS = arr;
        renderPuntosDeVenta();
    }
    // --- GASTOS modo LocalStorage ---
    async function addGastoLS(monto, concepto, categoria) {
        const arr = loadFromLS(getLSKey(LS_KEYS.GASTOS), []);
        arr.push({
            id: crypto.randomUUID(),
            fecha: new Date().toISOString(),
            monto: monto,
            concepto: concepto,
            categoria: categoria,
            registrado_por: userId,
        });
        saveToLS(getLSKey(LS_KEYS.GASTOS), arr);
        gastos = arr;
        renderGastos();
    }
    async function deleteGastoLS(id) {
        let arr = loadFromLS(getLSKey(LS_KEYS.GASTOS), []);
        arr = arr.filter(g => g.id !== id);
        saveToLS(getLSKey(LS_KEYS.GASTOS), arr);
        gastos = arr;
        renderGastos();
    }
    // --- CONFIGURACIÓN modo LocalStorage ---
    async function updatePrecioUnidadLS(newPrice) {
        const config = { precioUnidad: newPrice };
        saveToLS(getLSKey(LS_KEYS.CONFIG), config);
        precioUnidad = newPrice;
        showModal("Éxito", `El precio por unidad se ha actualizado a $${newPrice.toFixed(2)}. Las deudas de los vendedores se recalcularán.`, () => {}, false);
    }
    // --- Cargar todo desde LocalStorage al iniciar ---
    function loadAllLS() {
        vendedores = loadFromLS(getLSKey(LS_KEYS.VENDEDORES), []);
        puntosDeVenta = loadFromLS(getLSKey(LS_KEYS.PUNTOS_DE_VENTA), []);
        movimientosPOS = loadFromLS(getLSKey(LS_KEYS.MOVIMIENTOS_POS), []);
        gastos = loadFromLS(getLSKey(LS_KEYS.GASTOS), []);
        const config = loadFromLS(getLSKey(LS_KEYS.CONFIG), { precioUnidad: 10 });
        precioUnidad = config.precioUnidad || 10;
    }

    function formatFecha(fecha) {
        if (!fecha) return { date: '', time: '' };
        if (typeof fecha === "string") {
            const d = new Date(fecha);
            return {
                date: d.toLocaleDateString('es-ES', { dateStyle: 'short' }),
                time: d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
            };
        } else if (typeof fecha.toDate === "function") {
            const d = fecha.toDate();
            return {
                date: d.toLocaleDateString('es-ES', { dateStyle: 'short' }),
                time: d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
            };
        }
        return { date: '', time: '' };
    }

    // ... (El resto de la lógica/renderizado de pestañas aquí, usando formatFecha en POS y Gastos)

    // --- Firebase Initialization and Auth ---
    if (firebaseConfig) {
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        const setupAuth = async () => {
            try {
                await setPersistence(auth, browserSessionPersistence);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            userId = user ? user.uid : 'Anonimo-' + crypto.randomUUID();
            userIdDisplay.textContent = `ID Usuario: ${userId.substring(0, 10)}...`;
            isAuthReady = true;
            hideLoading();
            renderTab(currentTab);
            setupFirestoreListeners();
        });

        setupAuth();
    } else {
        userId = 'Sim-' + crypto.randomUUID();
        userIdDisplay.textContent = 'Modo Simulación';
        isAuthReady = true;
        loadAllLS();
        hideLoading();
        renderTab(currentTab);
    }

    // ... El resto de código de renderizado (renderVendedores, renderPuntosDeVenta, renderGastos, renderResumen, renderConfiguracion, etc.)
    // En POS y Gastos usa SIEMPRE formatFecha para mostrar fechas.

    tabButtons.forEach(button => {
        button.addEventListener('click', (e) => renderTab(e.target.dataset.tab));
    });

    function svgIcon(iconName, classes) {
        if (iconName === 'trash') {
            return `<svg class="${classes}" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>`;
        }
        if (iconName === 'close') {
            return `<svg class="${classes}" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>`;
        }
        if (iconName === 'copy') {
            return `<svg class="${classes}" fill="none" viewBox="0 0 24 24" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a1 1 0 001 1h5m-5-4h4a1 1 0 011 1v7m-4-7v7a1 1 0 01-1 1H3a1 1 0 01-1-1V9a1 1 0 011-1h7M17 9l4 4m0 0l-4 4m4-4H9"/></svg>`;
        }
        return '';
    }
</script>
</body>
</html>
